<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="./css/main.css" rel="stylesheet" >
  <link href="./css/FontAwesome/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/splitting.css" />
  <script src="./js/splitting.js"></script>
  <meta charset="utf-8"  />
  <title>Kapsas</title>
</head>
<body>
  <div>
    <div class="directChildrenInheritMarginTop" style="margin-top: 8px;">

      <div>
        
        <label for="css-var-input-font-text-medium">Min font size</label>
        <input id="css-var-input-font-text-medium" type="number" value="72"></input>
        <label for="css-var-input-font-text-large">Max font size</label>
        <input id="css-var-input-font-text-large" type="number" value="96"></input>
        <label for="css-var-input-row-height">Row height</label>
        <input id="css-var-input-row-height" type="number" value="130"></input>
      </div>
      <div>
        <label for="css-var-input-font-animation-duration">Duration</label>
        <input id="css-var-input-font-animation-duration" type="number" value="4000"></input>
        <label for="css-var-input-font-animation-delay">Delay</label>
        <input id="css-var-input-font-animation-delay" type="number" value="400"></input>
        
      </div>
      <div>
        <label for="css-var-input-bg-color">BG color</label>
        <input type="color" id="css-var-input-bg-color" value="#f5f5d4">
        <label for="css-var-input-text-color">Text color</label>
        <input type="color" id="css-var-input-text-color" value="#000000">
        
      </div>

      <div class="directChildrenInheritMarginTop" style="margin-top: 4px;">
        <div class="center">
          <label for="input-text-textarea">Text</label>
          <textarea name="input-text" id="input-text-textarea" style="font-size: 18px;"></textarea>
        </div>

        <div class="center">
          <label for="input-text">Keyframes</label>
          <textarea name="input-text" id="input-keyframes-textarea" style="font-size: 18px;"></textarea>
        </div>

        <div class="center">
          <label class="button">
            <span><i class="fas fa-upload"></i>Upload font</i></span>
            <input style="display: none" type="file" id="input-font" class="csvFile" accept=".ttf">
          </label>
        </div>

        <div>
            <input type="button" style="width: 120px; height: 40px;" id="input-button-animation-state-toggle" value="State: running">
            <input id="btn-start" style="width: 120px; height: 40px;" type="button" value="Start">
        </div>
      </div>
    </div>

    <div class="font-uploaded set-keyframes-target" id="input-to-output-text-render" style="margin-top: 40px;">
        <div data-splitting>
          Content will be rendered here
        </div>
    </div>
  </div>
</div>
</body>
</html>

<script type="module">

  main();

  function main() {
    SetCssValues();
    SetHtmlValues();
    HandleEvents();
  }

  function HandleEvents() {
    FontSizeEvents();
    RowHeightEvent();
    AnimationEvents();
    KeyframeChangeEvent();
    HandleAnimationStateEvent();
    ColorEvents();
    HandleStartEvent();
    HandleFontFileUploadEvent();
  }

  function ColorEvents() {
    const inputHandler = function(e, styleVariable) {
      let root = document.documentElement;
      console.log(e.target.value)
      root.style.setProperty(styleVariable, e.target.value);
    }
    
    let elementInputBgColor = document.querySelector("#css-var-input-bg-color");
    let elementInputTextColor = document.querySelector("#css-var-input-text-color");
 
    elementInputBgColor.addEventListener('change', (e) => { inputHandler(e, "--bg-color"); });
    elementInputTextColor.addEventListener('change', (e) => { inputHandler(e, "--text-color"); });
  }

  function AnimationEvents() {
    const inputHandler = function(e, styleVariable) {
      let root = document.documentElement;
      root.style.setProperty(styleVariable, e.target.value + "ms");
    }
    
    let elementInputMedium = document.querySelector("#css-var-input-font-animation-duration");
    let elementInputLarge = document.querySelector("#css-var-input-font-animation-delay");

    elementInputMedium.addEventListener('input', (e) => { inputHandler(e, "--animation-duration"); });
    elementInputLarge.addEventListener('input', (e) => { inputHandler(e, "--animation-delay"); });
  }

  function FontSizeEvents() {
    const inputHandler = function(e, styleVariable) {
      let root = document.documentElement;
      root.style.setProperty(styleVariable, e.target.value + "px");
    }
    
    let elementInputMedium = document.querySelector("#css-var-input-font-text-medium");
    let elementInputLarge = document.querySelector("#css-var-input-font-text-large");
    
    elementInputMedium.addEventListener('input', (e) => { inputHandler(e, "--text-size-medium"); });
    elementInputLarge.addEventListener('input', (e) => { inputHandler(e, "--text-size-large"); });

  }

  function KeyframeChangeEvent() {
    let elementKeyframes = document.querySelector('#input-keyframes-textarea');
    elementKeyframes.addEventListener('input', (e) => ChangeKeyframes(elementKeyframes.value));
  }

  function RowHeightEvent() {
    let elementRowHeight = document.querySelector("#css-var-input-row-height");
    
    elementRowHeight.addEventListener('input', (e) => { 
      let root = document.documentElement;
      root.style.setProperty("--row-height", e.target.value + "px");
    });
  }

  function GetDefaultKeyframesValue() {
    return `
@keyframes breathe {
0% {
  font-variation-settings: 'wght' 100, 'wdth' 85;
  font-size: var(--text-size-medium);
}

60% {
  font-variation-settings: 'wght' 700, 'wdth' 100;
  font-size: var(--text-size-large);
}

100% {
  font-variation-settings: 'wght' 100, 'wdth' 85;
  font-size: var(--text-size-medium);
}
`.replace(/\r?\n/, "");  // forward slash starts and ends regex expression
  }


  function SetHtmlValues() {
    // Set values annoying to set using html to html elements
    // Newline can be set in html using &#10; (the linefeed character literal), but using \n or string templates is more elegant
    let elementInputText = document.querySelector("#input-text-textarea");
    elementInputText.value = 'regular\noxygen\nsurpass';
    let elementKeyframes = document.querySelector('#input-keyframes-textarea');
    elementKeyframes.value = GetDefaultKeyframesValue();
  }

  function SetCssValues() {
    ChangeKeyframes(GetDefaultKeyframesValue());
  }


  function PutTextIntoRender() {
    let elementInputText = document.querySelector("#input-text-textarea");
    let rows = elementInputText.value.split(/\r?\n/);
    let outputAreaBuilder = "";
    rows.forEach(row => {
      outputAreaBuilder += `<div class='fixed-height'>${row}</div>`;
    });
    let outputArea = document.querySelector("#input-to-output-text-render");
    outputArea.innerHTML = `<div data-splitting>${outputAreaBuilder}<\div>`;
  }

  function HandleStartEvent() {
    let runBtn = document.querySelector("#btn-start");
    runBtn.addEventListener('click', (e) => {
      PutTextIntoRender()
      Splitting();
    })
  }

  function ChangeKeyframes(keyframes) {
    // This is bad code
    var style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = keyframes;
    document.head.appendChild(style);
  }

  function HandleAnimationStateEvent() {
    let root = document.documentElement;
    root.style.setProperty('--animation-play-state', `running`)
    const toggle = document.getElementById('input-button-animation-state-toggle');
    toggle.addEventListener('click', () => {
      let newState = root.style.getPropertyValue('--animation-play-state') === 'running' ? 'paused' : 'running';
      root.style.setProperty('--animation-play-state', newState); 
      toggle.value = 'State: ' + newState;
    });
  }

  function HandleFontFileUploadEvent() {
    let reader = new FileReader();
    reader.onload = function(event) {
        let file = event.target.result;
        // document.head.append('<style type="text/css">@font-face { font-family:"MYFONT2"; src: url("'+file+'"); }</style>');
        SetFont(file)
    }
    let startReadingFile = (e) => {
      let inputFont = document.querySelector('#input-font');
      let input = inputFont.files[0];
      reader.readAsDataURL(input);
    }

    document.querySelector('#input-font').addEventListener("change", startReadingFile);

  }

  function SetFont(fontFile) {
    let newFontName = 'UploadedFont';
    let font = new FontFace(newFontName, `url(${fontFile})`);
    font.load().then(function(loaded_face) {
      document.fonts.add(loaded_face);
      document.documentElement.style.setProperty('--font-uploaded', `"${newFontName}"`)
    }).catch(function(error) {
      throw Error(error);
    });
  }

</script>